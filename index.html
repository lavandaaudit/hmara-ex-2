<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>IBONIRIUM · Cloud Barometer · Storm Edition</title>

<style>
body{
  margin:0;
  height:100vh;
  background:#0a0e14;
  font-family: monospace;
  color:#aaffcc;
  overflow:hidden;
}

/* ================= DEVICE ================= */
#device{
  position:fixed;
  top:16px;
  left:16px;
  width:280px;
  height:320px;
  pointer-events:none;
}

canvas{ position:absolute; inset:0; }

/* ================= INFO ================= */
#info{
  position:absolute;
  top:8px;
  left:12px;
  right:12px;
  font-size:11px;
  line-height:1.38;
  color:#c8ffdc;
  text-shadow:0 0 4px rgba(0,0,0,0.85);
}

#info b{ color:#6fffa0; }

#title{
  font-size:13px;
  color:#9affe0;
  margin-bottom:4px;
  letter-spacing:0.6px;
}

/* ================= CITY PANEL ================= */
#cities{
  position:absolute;
  top:188px;
  left:12px;
  right:12px;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:6px;
  pointer-events:auto;
}

.city-btn{
  font-family:monospace;
  font-size:11px;
  padding:6px 0;
  background:rgba(20,40,35,0.75);
  color:#9affe0;
  border:1px solid rgba(120,255,200,0.25);
  border-radius:6px;
  cursor:pointer;
  transition:all .2s ease;
}

.city-btn:hover{
  background:rgba(40,80,65,0.9);
}

.city-btn.active{
  background:rgba(90,180,140,0.85);
  color:#052018;
  border-color:#bfffe6;
}
</style>
</head>

<body>

<div id="device">
  <canvas id="cloud"></canvas>

  <div id="info">
    <div id="title">IBONIRIUM · CLOUD BAROMETER</div>
    <div>City: <b><span id="cityName">–</span></b></div>
    <div>Weather: <b><span id="wcode">–</span></b></div>
    <div>Cloud cover: <b><span id="cc">–</span>%</b></div>
    <div>Humidity: <b><span id="hum">–</span>%</b></div>
    <div>Wind: <b><span id="wind">–</span> m/s</b></div>
    <div>Visibility: <b><span id="vis">–</span> km</b></div>
    <div>Cloud factor: <b><span id="cf">–</span></b></div>
  </div>

  <!-- ================= CITY BUTTONS ================= -->
  <div id="cities"></div>
</div>

<script>
const canvas = document.getElementById('cloud');
const ctx = canvas.getContext('2d');
canvas.width = 280;
canvas.height = 320;

let cloudCover=0, humidity=50, weatherCode=0;
let windSpeed=0, windDir=0, visibility=10;
let cloudFactor=1, temperature=10;
let baseColor={r:240,g:245,b:255};

const cities = [
  { name:"Kyiv", lat:50.45, lon:30.52 },
  { name:"Tokyo", lat:35.68, lon:139.69 },
  { name:"New York", lat:40.71, lon:-74.01 },
  { name:"London", lat:51.51, lon:-0.13 },
  { name:"Berlin", lat:52.52, lon:13.41 },
  { name:"Sydney", lat:-33.87, lon:151.21 },
  { name:"Reykjavík", lat:64.13, lon:-21.9 },
  { name:"Buenos Aires", lat:-34.61, lon:-58.38 }
];

let currentCity = cities[0];

/* ================= UI ================= */
const citiesBox=document.getElementById('cities');
cities.forEach((c,i)=>{
  const b=document.createElement('button');
  b.className='city-btn'+(i===0?' active':'');
  b.textContent=c.name;
  b.onclick=()=>{
    document.querySelectorAll('.city-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentCity=c;
    updateWeather();
  };
  citiesBox.appendChild(b);
});

/* ================= NOISE ================= */
function noise(x,y){
  return Math.sin(x*17.13+y*91.77+Math.sin(y*4))*0.5+0.5;
}

/* ================= COLOR ================= */
function getCloudColor(code){
  if(code===0) baseColor={r:252,g:252,b:255};
  else if(code<=3) baseColor={r:235,g:240,b:255};
  else if(code<50) baseColor={r:220,g:225,b:255};
  else baseColor={r:200,g:215,b:255};
}

/* ================= CYCLONES ================= */
function generateCyclones(){
  const count=Math.max(1,Math.floor(windSpeed/2));
  const cyclones=[];
  for(let i=0;i<count;i++){
    cyclones.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height,
      strength:0.6+Math.random()*0.7,
      radius:18+Math.random()*20
    });
  }
  return cyclones;
}
let cyclones=generateCyclones();

/* ================= DRAW ================= */
function drawCloud(){
  const t=Date.now()*0.0005;
  const w=canvas.width,h=canvas.height;
  const cx=w*0.52,cy=h*0.5;
  ctx.clearRect(0,0,w,h);

  const windX=Math.cos(windDir*Math.PI/180)*windSpeed*0.08;
  const windY=Math.sin(windDir*Math.PI/180)*windSpeed*0.05;
  const turbulence=Math.max(0,(windSpeed-6)/6);
  const fogFactor=Math.max(0,1-visibility/5);
  const baseSize=64+cloudCover*0.45;

  for(let i=0;i<5;i++){
    const scale=0.009+i*0.003;
    ctx.globalAlpha=(0.22+i*0.1)*(humidity/120+0.5);
    for(let y=0;y<h;y+=3){
      for(let x=0;x<w;x+=3){
        let nx=(x-cx)*scale+windX*t;
        let ny=(y-cy)*scale+windY*t;
        if(turbulence>0){
          nx+=noise(ny*2,t)*turbulence*0.8;
          ny+=noise(nx*2,t+10)*turbulence*0.8;
        }
        cyclones.forEach(c=>{
          const d=Math.hypot(x-c.x,y-c.y);
          if(d<c.radius){
            const a=Math.atan2(y-c.y,x-c.x)+t*c.strength;
            nx+=Math.cos(a)*d*0.02;
            ny+=Math.sin(a)*d*0.02;
          }
        });
        let n=noise(nx+t,ny);
        const dist=Math.hypot(x-cx,y-cy)/baseSize;
        let falloff=Math.max(0,1-dist*dist*1.35);
        falloff*=Math.max(0.4,1-fogFactor*0.6);
        if(n*falloff>0.38){
          ctx.fillStyle=`rgba(${baseColor.r},${baseColor.g},${baseColor.b},${falloff})`;
          ctx.fillRect(x,y,3,3);
        }
      }
    }
  }
  ctx.globalAlpha=1;
}

/* ================= WEATHER ================= */
async function updateWeather(){
  try{
    const r=await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${currentCity.lat}&longitude=${currentCity.lon}&current=`+
      'relative_humidity_2m,cloud_cover,weather_code,wind_speed_10m,wind_direction_10m,visibility,temperature_2m'
    );
    const d=await r.json();
    const c=d.current;

    weatherCode=c.weather_code;
    cloudCover=c.cloud_cover;
    humidity=c.relative_humidity_2m;
    windSpeed=c.wind_speed_10m;
    windDir=c.wind_direction_10m;
    visibility=(c.visibility??10000)/1000;

    cloudFactor=0.6+cloudCover/45+humidity/200+windSpeed/16;
    getCloudColor(weatherCode);
    cyclones=generateCyclones();

    cityName.textContent=currentCity.name;
    wcode.textContent=weatherCode;
    cc.textContent=cloudCover;
    hum.textContent=humidity;
    wind.textContent=windSpeed.toFixed(1);
    vis.textContent=visibility.toFixed(1);
    cf.textContent=cloudFactor.toFixed(2);
  }catch(e){console.warn(e);}
}

updateWeather();
setInterval(updateWeather,15*60*1000);

function loop(){
  drawCloud();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
